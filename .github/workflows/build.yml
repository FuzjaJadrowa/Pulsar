name: Build

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      - name: Check changelog file
        run: |
          if [ ! -f .github/changelog.md ]; then
            echo "No changelog detected" > .github/changelog.md
          fi
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: Pulsar ${{ github.ref_name }}
          body_path: .github/changelog.md
          draft: true
          prerelease: false

  build-tauri:
    needs: create-release
    if: always()
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            os_name: 'win64'
            args: ''
          - platform: 'macos-latest'
            os_name: 'macos'
            args: '--target aarch64-apple-darwin'
          - platform: 'ubuntu-22.04'
            os_name: 'linux'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin' || '' }}

      - name: Install dependencies (Node)
        run: npm install

      - name: Get version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Build app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}

      - name: Rename Artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $ver = "${{ env.VERSION }}"
          $os = "${{ matrix.os_name }}"
          
          $installer = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe" | Select-Object -First 1
          $newNameInstaller = "Pulsar-$ver-$os.exe"
          Copy-Item $installer.FullName -Destination $newNameInstaller
          
          $exe = "src-tauri/target/release/pulsar.exe"
          $newNameZip = "Pulsar-$ver-$os.zip"
          Compress-Archive -Path $exe -DestinationPath $newNameZip
          
          echo "ASSET_INSTALLER=$newNameInstaller" >> $env:GITHUB_ENV
          echo "ASSET_PORTABLE=$newNameZip" >> $env:GITHUB_ENV

      - name: Rename Artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          ver="${{ env.VERSION }}"
          os="${{ matrix.os_name }}"
          
          cp src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg "Pulsar-$ver-$os.dmg"
          
          # Przechodzimy do folderu, żeby zip nie zawierał ścieżek
          cd src-tauri/target/aarch64-apple-darwin/release/bundle/macos
          zip -r "../../../../../../Pulsar-$ver-$os.zip" "Pulsar.app"
          cd -
          
          echo "ASSET_INSTALLER=Pulsar-$ver-$os.dmg" >> $GITHUB_ENV
          echo "ASSET_PORTABLE=Pulsar-$ver-$os.zip" >> $GITHUB_ENV

      - name: Rename Artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          ver="${{ env.VERSION }}"
          os="${{ matrix.os_name }}"
          
          cp src-tauri/target/release/bundle/appimage/*.AppImage "Pulsar-$ver-$os.AppImage"
          
          cp src-tauri/target/release/bundle/deb/*.deb "Pulsar-$ver-$os.deb"
          
          tar -czvf "Pulsar-$ver-$os.tar.gz" -C src-tauri/target/release pulsar
          
          echo "ASSET_APPIMAGE=Pulsar-$ver-$os.AppImage" >> $GITHUB_ENV
          echo "ASSET_DEB=Pulsar-$ver-$os.deb" >> $GITHUB_ENV
          echo "ASSET_PORTABLE=Pulsar-$ver-$os.tar.gz" >> $GITHUB_ENV

      - name: Upload Release Assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ASSET_INSTALLER }}
            ${{ env.ASSET_PORTABLE }}
            ${{ env.ASSET_APPIMAGE }}
            ${{ env.ASSET_DEB }}